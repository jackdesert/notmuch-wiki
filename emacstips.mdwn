[[!img notmuch-logo.png alt="Notmuch logo" class="left"]]
#Tips and Tricks for using notmuch with Emacs

The main client based on notmuch is notmuch.el, which is included in the notmuch package. It is might, and allows you to configure a lot of things, however, it might not be immediately obvious how, and how the general workflow generally looks like. This [first section](#typical_workflow) will describe a typical workflow and setup, while the section [Advanced tips and tweaks](#advanced_tips) below, focuses on more specific questions.

<h2 id="typical_workflow">Typical setup and workflow</h2>

### Set up & receiving mails

Notmuch requires either a MailDir or a "mh"-style maildirectory to operate on. (It basically requires any setup in which each mail is in a file of it's own.) Most people use "[offlineimap](http://software.complete.org/software/projects/show/offlineimap)" or "[mbsync](http://isync.sourceforge.net/)" in order to synchronize their IMAP or pop mail server with a local mail store. offlineimap is quite useful and widely tested, it also offers a handy hook that will come in useful a bit later in our setup. 

So go install and configure offlineimap so you can simply run offlineimap and have an updated maildir. In the [Account xxx] section of your .offineimaprc file your can specify a "presynchook" and "postsynchook" command that will get run whenever you sync. Point _postsynchook_ to a script that gets run on every sync and that will do the automatic tagging and updating of your notmuch database.

The script will look somewhat like this:

>     #/bin/sh
>     # incorporate all new mails in the database
>     notmuch new > /dev/null
>     #apply some automatic tags
>     notmuch tag +notmuch from:notmuch@notmuchmail.org and not tag:notmuch
>     ...more tag rules...

If you don't need automatic tagging, just use "notmuch new > /dev/null" as your synchook. One advanced setup with automatic tagging has been described by James Vasile here (id: _87hbp5j9dv.fsf@hackervisions.org_). Carl Worth has described his script in this mail (id: _87r5o8stbj.fsf@yoom.home.cworth.org_) in the same thread. If you are confused by those ids, read more on message ids below.


> __A note on message ids__: Confused by those message ids? Get used to it because they are an importance part of the notmuch workflow. Every send message has a unique message id, just like a website has a unique url. On the notmuch mailing list people will throw around message ids and expect people to just find the right mails, as this is what notmuch makes easy. In order to find a specific message, hit 's' for search and type: "id:messageidhere". If you incorporated the notmuch mail archive, you can e.g. try to find id:87r5o8stbj.fsf@yoom.home.cworth.org. Don't have the notmuch archive back to Feb 25, 2010? Fortunately gmane (and probably others allow to search for message id in their archives as well. You'll find this message under [http://mid.gmane.org/87r5o8stbj.fsf@yoom.home.cworth.org](http://mid.gmane.org/87r5o8stbj.fsf@yoom.home.cworth.org) (incidentally, this server seems to be down right now).

### Synchronizing notmuch tags with maildir flags
IMAP users rely on their maildir flags that convey the status "seen", "replied", "trashed", and so on in order to synchronize the status of their mail across mail clients. notmuch will by default happily ignore those flags and will never modify them either. If you want to use your mail with non-notmuch clients too, please check out the entry on "[how to sync notmuch tags and maildir flags](#sync_maildir_flags)".

### Navigating & reading mails
OK, messages are now in your maildir and they have the tags you want them to have (of course you will be assigning more tags manually as you parse through your mail.). Now, on to actually using notmuch in emacs. If you added the correct bits to your .emacs file you will be able to start notmuch by typing "M-x notmuch" (or M-x notmuch-folder). If you want to start notmuch immediately when starting emacs you can also call emacs as "emacs -f notmuch" (and create a handy shortcut on your desktop for that).

notmuch (the search view) and notmuch-folder are the 2 main views that can be used to navigate through your mail.
__[TODO: to be continued...]__
See information on how to customize your notmuch-folder view [here](#customize_notmuch_folder).

###Sending mail
Notmuch itself does not provide any facilities for sending mail. Fortunately, emacs comes with "message mode" which offers that functionality. This also means that there are various methods to invoke the mail sending command. One possibility is to use "CTRL-x m" which will invoke a new "message mail" window. The second possibility is to type 'm' when you are in a notmuch window. And finally, when looking at a message or thread in notmuch you can type 'r' to start a reply.

If you want to use mail address autocompletion, check out [bbdb](http://bbdb.sourceforge.net) which works nicely together with message mode.

Type your message and send it off with ctrl-c ctrl-c. By default message mode will use your /usr/sbin/sendmail command to send a mail, so make sure that works.
One annoying standard configuration of message mode is that it will hide the sent mail in your emacs frame stack, but it will not close it. If you type several mails in an emacs session they will accumulate and make switching between buffers more annoying. You can avoid that behavior by adding `(setq message-kill-buffer-on-exit t)` in your .emacs file which will really close the mail window after sending it.

Currently, there is a slight problem with copying the sent mail into your "outbox". While conventional MUAs will automatically copy your sent mail to a "Sent" folder, notmuch will never touch your mail store and your sent mails will not be searchable by default. When replying with 'r' notmuch will insert a BCC header to yourself, but when sending a mail with 'm' or 'ctrl-x m', it will not (and can not as ctrl-x m does not involve notmuch at all). Please see the specific advice on "[fcc](how to do FCC/BCC)" for more details on how to set up notmuch to obey your preferences.

<h2 id="advanced_tips">Advanced tips and tweaks</h2>
* <span id="fcc">How to do FCC/BCC...</span>

  Any notmuch reply will automatically include your primary email
  address in a BCC so that any messages you send will (eventually) end
  up in your mail store as well.

  But this doesn't do anything for messages that you compose that are
  not replies. So we need to get sane message-mode FCC figured
  out. Some investigation is still needed here.

* * <span id="customize_notmuch_folder">How to customize notmuch-folders</span>

  There's a "notmuch-folder" command available in the emacs client
  that displays a list of "folders" and the number of messages in
  each. Each folder is simply a named search specification. To
  configure this mode, edit your ${HOME}/.emacs file and include text
  something like the following:

		(setq notmuch-folders '(("inbox" . "tag:inbox")
					("unread" . "tag:inbox AND tag:unread")
					("notmuch" . "tag:inbox AND to:notmuchmail.org")))

  Of course, you can have any number of folders, each configured
  with any supported search terms (see "notmuch help search-terms").

* Viewing HTML messages with an external viewer

  The emacs client can often display an HTML message inline, but it
  sometimes fails for one reason or another, (or is perhaps inadequate
  if you really need to see the graphical presentation of the HTML
  message).

  In this case, it can be useful to display the message in an external
  viewer, such as a web browser. Here's a little script that Keith
  Packard wrote, which he calls view-html:

		#!/bin/sh
		dir=3D`mktemp -d`
		trap "rm -r $dir" 0
		cat "$@" > "$dir"/msg
		if munpack -C "$dir" -t < "$dir"/msg 2>&1 | grep 'Did not find'; then
		    sed -n '/[Hh][Tt][Mm][Ll]/,$p' "$dir"/msg > $dir/part1.html
		    rm "$dir"/msg
		fi
		for i in "$dir"/part*; do
		    if grep -q -i -e '<html>' -e 'text/html' "$i"; then
			iceweasel "$i" &
			sleep 3
			exit 0
		    fi
		done

  Save that script somewhere in your ${PATH}, make it executable, and
  change the invocation of iceweasel to any other HTML viewer if
  necessary. Then within the emacs client, press "|" to pipe the
  current message, then type "view-html".

  Keith mentions the following caveat, "Note that if iceweasel isn't
  already running, it seems to shut down when the script exits. I
  don't know why."

* <span id="sync_maildir_flags">how to sync notmuch tags and maildir flags]</span>

  __[TODO: This is a wiki. write me!]__
  [mention patches that exist to honor maildir tags and notmuchsync.]